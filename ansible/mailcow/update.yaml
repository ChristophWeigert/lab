---
- name: Update mailcow if needed
  hosts: mailcow
  gather_facts: no
  tasks:
    - name: Change directory to Mailcow install path
      command: cd {{ mailcow__install_path }}
      args:
        warn: false
      ignore_errors: yes

    - name: Update updater
      git:
        repo: https://github.com/mailcow/mailcow-dockerized.git
        dest: "{{ mailcow__install_path }}"
        version: master
        update: yes
      register: git_result
      changed_when: git_result.changed

    - name: Execute update.sh -c
      command: ./update.sh -c
      args:
        chdir: "{{ mailcow__install_path }}"
      register: update_check_output
      changed_when: false

    - name: Check if updated code is available
      shell: echo "{{ update_check_output.stdout }}" | grep -q 'Updated code is available'
      register: updated_code_available
      changed_when: false

    - name: Upgrade Mailcow
      command: printf "%s\n" "y" "y" | ./update.sh
      args:
        chdir: "{{ mailcow__install_path }}"
      when: updated_code_available.stdout

    - name: Collect garbage
      command: echo 'y' | ./update.sh --gc
      args:
        chdir: "{{ mailcow__install_path }}"
      when: updated_code_available.stdout

    - name: Print message if no updates available
      debug:
        msg: "No updates are available"
      when: not updated_code_available.stdout