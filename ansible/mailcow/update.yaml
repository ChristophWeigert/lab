---
- name: Update mailcow if needed
  hosts: mailcow
  gather_facts: false
  tasks:
    - name: Update updater
      ansible.builtin.git:
        repo: https://github.com/mailcow/mailcow-dockerized.git
        dest: "{{ mailcow__install_path }}"
        version: master
        update: true
      register: git_result
      changed_when: git_result.changed

    - name: Execute update.sh -c
      ansible.builtin.command: ./update.sh -c
      args:
        chdir: "{{ mailcow__install_path }}"
      register: update_check_output
      changed_when: false

    - name: Check if updated code is available
      ansible.builtin.shell: |
        set -o pipefail
        echo "{{ update_check_output.stdout }}" | grep -q 'Updated code is available'
      register: updated_code_available
      changed_when: updated_code_available.stdout

    - name: Upgrade Mailcow
      ansible.builtin.command: printf "%s\n" "y" "y" | ./update.sh
      args:
        chdir: "{{ mailcow__install_path }}"
      when: updated_code_available.stdout

    - name: Collect garbage
      ansible.builtin.command: echo 'y' | ./update.sh --gc
      args:
        chdir: "{{ mailcow__install_path }}"
      when: updated_code_available.stdout

    - name: Print message if no updates available
      ansible.builtin.debug:
        msg: "No updates are available"
      when: not updated_code_available.stdout
